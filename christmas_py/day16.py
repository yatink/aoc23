import time

from os import system


def move(num_rows, num_cols, direction, row, col):
    if direction == 'U' and row == 0:
        return None
    if direction == 'U':
        return row-1, col
    if direction == 'L' and col == 0:
        return None
    if direction == 'L':
        return row, col-1
    if direction == 'D' and row == num_rows-1:
        return None
    if direction == 'D':
        return row+1, col
    if direction == 'R' and col == num_cols-1:
        return None
    if direction == 'R':
        return row, min(col+1, num_cols-1)
    

DIRECTION_MODIFIERS = {
    ('U', 'X'): ('L', None),
    ('U', '/'): ('R', None),
    ('U', '.'): ('U', None),
    ('U', '|'): ('U', None),
    ('U', '-'): ('L', 'R'),
    ('D', 'X'): ('R', None),
    ('D', '/'): ('L', None),
    ('D', '.'): ('D', None),
    ('D', '|'): ('D', None),
    ('D', '-'): ('L', 'R'),
    ('L', 'X'): ('U', None),
    ('L', '/'): ('D', None),
    ('L', '.'): ('L', None),
    ('L', '-'): ('L', None),
    ('L', '|'): ('U', 'D'),
    ('R', '/'): ('U', None),
    ('R', 'X'): ('D', None),
    ('R', '.'): ('R', None),
    ('R', '-'): ('R', None),
    ('R', '|'): ('U', 'D'),
}


def update_position(grid: list[list[str]], light_ray_position: tuple[str, int, int]):
    num_rows = len(grid)
    num_cols = len(grid[0])
    direction, row, col = light_ray_position
    grid_pos = grid[row][col]
    dir1, dir2 = DIRECTION_MODIFIERS[(direction, grid_pos)]
    n1 = move(num_rows, num_cols, dir1, row, col)
    n2 = move(num_rows, num_cols, dir2, row, col)
    pos1 = (dir1, *n1) if n1 is not None else None
    pos2 = (dir2, *n2) if n2 is not None else None
    return pos1, pos2


def parse_input(inpt):
    grid = inpt.split("\n")
    return grid


def print_grid(grid, energized_positions, curr=None):
    time.sleep(0.2)
    for r in range(len(grid)):
        en_row = []
        for c in range(len(grid[0])):
            prnt = grid[r][c] if grid[r][c] != 'X' else '\\'
            if (r,c) == curr:
                print('\x1b[1;30;43m' + prnt  + '\x1b[0m', end='')
                en_row.append('*')
            elif (r,c) in energized_positions:
                en_row.append('#')
                print('\x1b[0;30;42m' + prnt  + '\x1b[0m', end='')
            else:
                en_row.append('.')
                print('\x1b[1;31;40m' + prnt  + '\x1b[0m', end='')
        print('   ', end=' ')
        print("".join(en_row))
        #system('clear')
    print('\n')


def part1(inpt, initial=('R', 0, 0)):
    cache: set[tuple[str, int, int]] = set()
    visited = set()
    grid = parse_input(inpt)
    # Start off the light ray in the top right corner
    # going right
    light_ray_starting_positions = [initial]
    # print("Initial !!")
    # print_grid(grid, visited)
    while light_ray_starting_positions:
        # Get the first light ray from the lightrays
        light_ray_position = light_ray_starting_positions.pop(0)
        # while light_ray not in visited
        #time.sleep(1.0)
        while light_ray_position not in cache:
            # Add the position to the visited set
            cache.add(light_ray_position)
            visited.add((light_ray_position[1], light_ray_position[2]))
            # Move the light ray forwards
            light_ray_position, new_light_ray = update_position(grid, light_ray_position)
            # if light_ray_position is not None:
            #     print_grid(grid, visited, (light_ray_position[1], light_ray_position[2]))
            # If the light ray is split
            # Add the new light ray to the light_rays
            if new_light_ray is not None and new_light_ray not in cache:
                light_ray_starting_positions.append(new_light_ray)
            if light_ray_position is None:
                break

    # print_grid(grid, energized_positions)

    return len(visited)


def part2(inpt):
    grid = parse_input(inpt)
    start_positions = [('R',r,0) for r in range(len(grid))] + \
        [('L',r,len(grid[0])-1) for r in range(len(grid))] + \
        [('U',len(grid)-1,c) for c in range(len(grid[0]))] + \
        [('D',0,c) for c in range(len(grid[0]))]
    energies = [part1(inpt, initial=x) for x in start_positions]
    return max(energies)



if __name__ == '__main__':
    test_inpt = """.|...X....
|.-.X.....
.....|-...
........|.
..........
.........X
..../.XX..
.-.-/..|..
.|....-|.X
..//.|...."""
    test_inpt2 = """-/...X....
|.-.X.....
.....|-...
........|.
..........
.........X
..../.XX..
.-.-/..|..
.|....-|.X
..//.|...."""

    
    real_inpt = \
"""X.......X..//-.............-/....|....../-....|..................................|........--/.................
..|/..-..X..........X.....|......X...-....../...................................................|.../||X......
....././X..........-|....|....-..........................X.......|.............................-/X............
...........X..-...X...................|.......X/./../...|.....-.|....|.........................|..............
............|-..............-....................-...X.........|.............-..................X...|.....//..
.....X......................./............|..................|...|.............................../...........|
.........-..-...|...X....-........................../....-.........-|.......|......|....................-.....
............../..../...../..X..../................../............../..X.................././......./..........
...-..|.....-./X...../..../.|..X.......-........................../.X.............X...........................
............|.-..../.............................|......X.........|......--....-.........-..................|.
..|..X........../...XX............X........X-...........-....|.....X....|..................|../...../.........
....|..-....................-./-...............................|......./........../....|.....X.|..X...X.......
..../......................|.....|...............-..../X......................-.......X.......................
............................X.|.-.|.............-.................................................-...........
...|.-.......................X|..-......-.................|.......-..X.......X-..................|............
.............................X......................X.../.X.|...........X....|..X.............................
-.../...|................/.-......./..........|.........|........./||.-.........X.....X...-............./.|...
........../......../-.........................................../.......-|.|....................|...|../...../
......|................|............./.......X.............-..............X|.......-..X./...../.-.../....../..
/............|X........../.......X......-..|......../-../.........|X....../............X.........|...|........
...............-.........|........................../.........X............-X....X......../..................|
................X.X................X....-.......-.....-......|..|...X/........./...../..|.............|.......
............................................................................................................/.
................................|..-/...................../.....-.............|...-...........................
...................-/..................||./.............|..........|..................-.../..................|
..................X/...|...X.-.........../....-......................-X.......|......./.........|..|.X..-.....
........................|.-..................-........................./................X.../...X...|.........
..................-.........-/.....X......|...../X...-......X....-....................................../.....
.....................|..............X........X....X...............-........../......X...........X.............
...X./......................-.X..........X.-..X........-.................-.......-.||......................./.
...|..............X..|............X....|............|.....X......../...........-...................X...../../.
.........X.........................X.............../........//.................|.........X.-...............-..
.............X....-..../..-................./...|/...-...................|../.../.............-......../.....|
-.....||/.......X......../..............................|...............................................-.....
.......|......X........../|........................../-........../.X..X..............-.......|/|....-.........
../-.............-.X-........./........-........X...|...........-.X./..X.X....................................
/.X................../.....|...........-............-.......-......./.X.X..|...........X......../.............
..............................|.....-...|...X.......-.........X..X-..........-....X......|...........|/...-...
.......X......XX......-.....-.....-........|../........X..|.............X../................../...X......./..X
..-.........|............./............./.-.|.....|...../..............................................X...|..
|......................./......-....-............/.................//...........X.............-..X............
............X.....................-......-..|.X.......X/..........X............/....X.../.....................
|.............................|........./........................X.................../.........|........../X..
.../...|/.-.......-.............X......................................./........--..................X........
.X...........X..-|............-...-.X...../...........-..|.............././.................|........../......
...............-......................./..............X..X........................X.............-../..........
................................X..../..................X.....................X............/............./....
...-..../../.......-............-......|...../.........|............................|...../../..............-|
.........|.......-..../..........................................X|.|./.....-..X.-.....................|......
............X............................................|................-...-................X..............
|...................................-...|/......|............./........./...|...................|....X........
|......X-......................./.-.............../.|X-..|................-.....|../-X.|.-..-|.........-.|-X.-
......-......|-......|.................-.-..X..../-./.............................................|-......./..
.-...............................X...........................-|.......-.......................................
.............X.|....|....X.............../..X..|..................../.............|...-X......................
........-.X/.....................|........-......./............../..............X..X.............|......./....
..-....../-..........................|...../..X...............X..........-....X...........|.X...X.............
...........|............................................../...................X.X.X...........................
../.................|X.|.X..-..X........X...-..-........-..X....-...............-..............X...........|/.
........X.|....................../...........//................/.................X..../.....-.................
.....X...X.....X.......X......X.....-|./..|............./|./|-X.........................-........--...........
..|................../.....X.....|.......-...|............-../................-...X........-.......|..XX......
.....|......../....X....../...X........................................X..X..............-..................|.
....//......X.........-......./.X..X........./..........-....-.....X..-...|...................X.../......|....
...............|...................../.X.............-...X.....X..|..................../.............X.....|..
X.....................-............/.............X...-...................../...-..-.....|./..............X....
........................-../......X.............-........-.X/.....|.-..........-............../..-....-XX..-..
.........../.................X.....|..../.X.........|........./...-..........................X................
|....................../..../.......................-................X...................................-./..
...|.......X-.......X........X..........-........................./...../.........................-../........
.............X.......-....-..|...X..../.-...X......|....................|..-./...................X............
...............X./.X...............|.............X./......|...........................-.........../.|.........
...../....../..............|.................../.....|.....X............................/.X...../...X|........
.X............/......................-......./................-/./.|....................................-.....
.................../.......X........../-.............................|X.......................................
../....................X....../......./.....................................|................-/X...|..........
X................/........................--.........../X....X../....../..........|-............-.............
./X..................--......X..../.....X.......-..............................|.............-.............X..
....|.....|...............................X//.................|..........|.-.........X................././....
../....-...............-...|...............-...-................./......-..-/...........-....../..........|-..
..........|.|/..............................-./|...|..|......X............................-...-...|...........
..X..........................................................-......................../../................-...
.....|X..........................X................|................X.../.......X..|.X.........-.......X.-.....
.......................|..X..........|.......X.-.................XX........-............|.....................
......./.................|.X...|............................./X............X.....|.....|-...|.....|.......|...
....../...-.........../|...............-.............................X../...........X...........|...........|.
..-..................X....X/.........|.....X......................-...........................................
....|.....-................................/.........-|...........X....X.-./....X........................../..
....../........X................|......X.......|.................................X............................
....-......./......./-.../.......X...........|..............|................................|......|.........
-....................-.............................|......X......|.........//...........X........X............
X............./...../.....-.......-X...........-...........X.|.............-/.....|......|.../................
.......................|/X..X............|..|...................../.......-X........|.....|....X.....X...-....
.......-............|........................../..X.|.................X...............X............|...|...|..
......................../..-.......-.......-...-.............X............-......--..X..................|...X.
...............|.|......|.....X................-.........../.........X............X.............-.............
..X..........................|./......-........|....-.............-.......-.....X................/............
...../..................................................|......X..-........|..|.....................X.....-...
.....X....|.........|.........|.................../.............X......|.......|..........X............./.../.
./.../............../.|....X./..././...................X...........|...........-......................X....X..
.../..............................-...............................X.............../..........-.............../
|..X-.........X../...........|.X..........-.........../..........|-...................................-.......
...........................|../.....X.........................|.....X........../..............................
..................-..........|.........|....|............../...-..../.............../-........XX.X.......-....
.............---..../....................-....-......../....../.........X..X............................../...
|.....|.......................././...............|.../..|.X............-.................../............./....
..-........X............./../|..........................--....|..X.........|/./................/...../........
..........X|.....................................--............/....../............X.|......|.......-|......X.
..........|-........X....|.....................X................................-X...|......../.........X..|..
..XX.........X..|../................|.........X.....--...-...X................/.............................X."""
    print(part1(test_inpt))
    print(part2(test_inpt))
    print(part1(real_inpt))
    print(part2(real_inpt))
